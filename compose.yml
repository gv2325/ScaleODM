# This file is used for running tests with an attached database
# 
# Prerequisites:
#   1. Talos cluster must be running (created via: just test-cluster-init)
#   2. Kubeconfig must be configured and point to the Talos cluster
#
# Quick start:
#   just dev              # Setup Talos cluster and start all services

networks:
  net:
    name: scaleodm

services:
  api:
    image: "ghcr.io/hotosm/scaleodm:${TAG_OVERRIDE:-ci}"
    build:
      target: build
    container_name: scaleodm
    # Use host networking to access localhost Kubernetes API (Talos cluster)
    # This also allows direct access to DB and S3 via localhost ports
    # Note: depends_on doesn't work with host networking, so ensure DB/S3 are up first
    network_mode: "host"
    env_file: .env
    environment:
      KUBECONFIG_PATH: /root/.kube/config
      # Override DB URL to use localhost since we're on host network
      SCALEODM_DATABASE_URL: ${SCALEODM_DATABASE_URL:-postgres://odm:odm@localhost:31101/scaleodm?sslmode=disable}
      # Override S3 endpoint to use localhost since we're on host network
      SCALEODM_S3_ENDPOINT: ${SCALEODM_S3_ENDPOINT:-localhost:31102}
    volumes:
      # Mount local files
      - ./go.mod:/code/go.mod:ro
      - ./go.sum:/code/go.sum:ro
      - ./main.go:/code/main.go:ro
      - ./main_test.go:/code/main_test.go:ro
      - ./app/api:/code/app/api:ro
      - ./app/config:/code/app/config:ro
      - ./app/db:/code/app/db:ro
      - ./app/meta:/code/app/meta:ro
      - ./app/s3:/code/app/s3:ro
      - ./app/workflows:/code/app/workflows:ro
      - $HOME/.kube/config:/root/.kube/config
    entrypoint: go
    command: run main.go
    restart: "unless-stopped"
    # entrypoint: test -timeout=2m -v ./...
    # restart: "no"

  db:
    # image: "postgis/postgis:18-3.6-alpine"
    image: "docker.io/postgres:18-alpine"
    container_name: scaleodm-db
    environment:
      - POSTGRES_USER=odm
      - POSTGRES_PASSWORD=odm
      - POSTGRES_DB=scaleodm
    ports:
      - "31101:5432"
    networks:
      - net
    restart: "unless-stopped"
    healthcheck:
      test: pg_isready -U odm -d scaleodm
      start_period: 5s
      interval: 10s
      timeout: 5s
      retries: 3

  s3:
    image: "docker.io/minio/minio:RELEASE.2025-01-20T14-49-07Z"
    environment:
      MINIO_ROOT_USER: ${SCALEODM_S3_ACCESS_KEY:-odm}
      MINIO_ROOT_PASSWORD: ${SCALEODM_S3_SECRET_KEY:-somelongpassword}
      MINIO_VOLUMES: "/mnt/data"
      MINIO_BROWSER: "off"
    # volumes:
    #   - s3_data:/mnt/data
    ports:
      - "31102:9000"
    networks:
      - net
    command: minio server
    restart: "unless-stopped"
    healthcheck:
      test: timeout 5s bash -c ':> /dev/tcp/127.0.0.1/9000' || exit 1
      interval: 5s
      retries: 3
      start_period: 5s
      timeout: 5s
